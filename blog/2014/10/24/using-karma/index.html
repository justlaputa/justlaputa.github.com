
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>using karma - Coding in the Sky</title>
  <meta name="author" content="laputa">

  
  <meta name="description" content="Recently I&rsquo;m trying to use Karma to do front-end javascript unit test. Here is my simple startup of setting up. Boilerplate project First, let& &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://laputa.io/blog/2014/10/24/using-karma">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Coding in the Sky" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h1>Coding in the Sky</h1>
  
    <h2><a href="/">Never wait</a></h2>
  
</hgroup>

</header>
  <nav role="navigation">
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:laputa.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Using Karma</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-24T10:09:48+09:00" pubdate data-updated="true">Oct 24<span>th</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Recently I&rsquo;m trying to use <a href="https://karma-runner.github.io/">Karma</a> to do front-end javascript unit test. Here is my simple startup of setting up.</p>

<h2>Boilerplate project</h2>

<p>First, let&rsquo;s make a boilerplate project for doing the test. Make prject structure like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>karma-boilerplate
</span><span class='line'>├── package.json
</span><span class='line'>├── README.md
</span><span class='line'>├── src
</span><span class='line'>│   └── hello.js
</span><span class='line'>└── test
</span><span class='line'>    └── hellpSpec.js</span></code></pre></td></tr></table></div></figure>


<p><code>hello.js</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function hello() {
</span><span class='line'>  return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>helloSpec.js</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>describe('hello', function() {
</span><span class='line'>  it('should return 0', function() {
</span><span class='line'>    expect(hello()).toEqual(0);
</span><span class='line'>  });
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<p>Or you can directly get the source code from <a href="https://github.com/justlaputa/karma-boilerplate">Github</a>.</p>

<h2>Install packages</h2>

<p>Karma is written by google&rsquo;s <a href="https://angularjs.org/">AngularJS</a> team, and they use <a href="http://nodejs.org/">Node.js</a>, so first we need to have node.js installed. If you don&rsquo;t have it, try to install in your platform: <a href="http://nodejs.org/download/">download</a>.</p>

<p>After that, let&rsquo;s install the packages we need:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ npm install karma --save-dev
</span><span class='line'>$ npm install karma-jasmine karma-phantomjs-launcher karma-chrome-launcher --save-dev</span></code></pre></td></tr></table></div></figure>


<p><code>karma</code> is the test runner, it will load our tests in browsers and run them, while others are all karma plugins.</p>

<ul>
<li>karma-jasmine: the unit test assertion library, it enables us to write BDD style test cases</li>
<li>karma-phantomjs-launcher: it enables karma to launcher the headless webkit browser phantomjs, which is convinient to do quick test</li>
<li>karma-chrome-launcher: it enables karma to launcher google Chrome to do read browser test</li>
</ul>


<h2>Configuration</h2>

<p>Karma has an <a href="https://karma-runner.github.io/0.12/intro/configuration.html">interactive</a> command to help us generate config files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./node_modules/karma/bin/karma init</span></code></pre></td></tr></table></div></figure>


<p>It will ask you some questions and you will be able to choose the answers from command line, after that it will generate a <code>karma.config.js</code> file for you.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./node_modules/karma/bin/karma init
</span><span class='line'>
</span><span class='line'>Which testing framework do you want to use ?
</span><span class='line'>Press tab to list possible options. Enter to move to the next question.
</span><span class='line'>&gt; jasmine
</span><span class='line'>
</span><span class='line'>Do you want to use Require.js ?
</span><span class='line'>This will add Require.js plugin.
</span><span class='line'>Press tab to list possible options. Enter to move to the next question.
</span><span class='line'>&gt; no
</span><span class='line'>
</span><span class='line'>Do you want to capture any browsers automatically ?
</span><span class='line'>Press tab to list possible options. Enter empty string to move to the next question.
</span><span class='line'>&gt; Chrome
</span><span class='line'>&gt; PhantomJS
</span><span class='line'>&gt;
</span><span class='line'>
</span><span class='line'>What is the location of your source and test files ?
</span><span class='line'>You can use glob patterns, eg. "js/*.js" or "test/**/*Spec.js".
</span><span class='line'>Enter empty string to move to the next question.
</span><span class='line'>&gt; src/**/*.js
</span><span class='line'>&gt; test/**/*Spec.js
</span><span class='line'>&gt;
</span><span class='line'>
</span><span class='line'>Should any of the files included by the previous patterns be excluded ?
</span><span class='line'>You can use glob patterns, eg. "**/*.swp".
</span><span class='line'>Enter empty string to move to the next question.
</span><span class='line'>&gt;
</span><span class='line'>
</span><span class='line'>Do you want Karma to watch all the files and run the tests on change ?
</span><span class='line'>Press tab to list possible options.
</span><span class='line'>&gt; yes
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Config file generated at "/home/laputa/workspace/github/karma-boilerplate/karma.config.js".</span></code></pre></td></tr></table></div></figure>


<p>Then it will generate <code>karma.config.js</code> file for you, there are two points about the karma config:</p>

<h4>Files</h4>

<p>Karma does not serve all files by default, which means it will only serve the files you specified in the config file. The problems come when you are using some loaders like <a href="http://requirejs.org/">RequireJS</a> or <a href="https://developers.google.com/closure/">Google Closure</a>. You should specify all you source code in <code>files</code> configuration, and prevent them to be included in the html page by default. For example:</p>

<p><em>RequireJS</em>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>files: [
</span><span class='line'>  { pattern: 'src/**/*.js', included: false, served: true },
</span><span class='line'>  'test/**/*Spec.js'
</span><span class='line'>]</span></code></pre></td></tr></table></div></figure>


<p><em>Closure</em>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>files: [
</span><span class='line'>  { pattern: 'CLOSURE_LIB_ROOT/**/*.js', included: false, served: true },
</span><span class='line'>  'src/**/*Spec.js'
</span><span class='line'>]</span></code></pre></td></tr></table></div></figure>


<h4>Iframe</h4>

<p>By default, Karma will load all script in an iframe, and run the test, but when you are using PhantomJS, phantomjs will expose global variables like <code>window._phantom</code>. If we want to detect phantomjs in our test source like:</p>

<p><code>testSpec.js</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  if (window._phantom) {
</span><span class='line'>    //Add some function that phantomjs not support
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>It won&rsquo;t happen because the <code>_phantom</code> global variable will not be set in the iframe. Now we need to specify Karma to not use iframe:</p>

<p><code>karma.config.js</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  client: {
</span><span class='line'>    useIframe: false
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>By this, all test will be run in a new window instead of in an iframe.</p>

<h2>Use grunt-karma</h2>

<p>If you want to use grunt to start karma, which will be helpful for CI runners, you can try to use <a href="https://github.com/karma-runner/grunt-karma">grunt-karma</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ npm install grunt-karma --save-dev
</span><span class='line'>$ npm install karma-junit-reporter --save-dev //this allows to output junit report for CI like Jenkins</span></code></pre></td></tr></table></div></figure>


<p>and you can write all your configuration in the Gruntfile.js instead of in a separate config.js file, it is also able to define separate options for different environment, like CI and local development. A simple example:</p>

<p><code>Gruntfile.js</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>karma: {
</span><span class='line'>  options: {
</span><span class='line'>    frameworks: ['jasmine'],
</span><span class='line'>    files: [
</span><span class='line'>      'src/**/*.js',
</span><span class='line'>      'test/**/*.js'
</span><span class='line'>    ]
</span><span class='line'>  },
</span><span class='line'>  continuous: {
</span><span class='line'>    singleRun: true,
</span><span class='line'>    browsers: ['PhantomJS'],
</span><span class='line'>    reporters: 'junit',
</span><span class='line'>    junitReporter: {
</span><span class='line'>      outputFile: 'test/reports/karma-results.xml'
</span><span class='line'>    },
</span><span class='line'>    client: {
</span><span class='line'>      useIframe: false //to avoid phantomjs detect failure
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  dev: {
</span><span class='line'>    reporters: 'dots',
</span><span class='line'>    bro1wsers: ['Chrome']
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>when run <code>grunt karma:continuous</code>, it will avoid using iframe, launch PhantomJS and output junit report for CI. while run <code>grunt karma:dev</code> will launcher Chrome for developers.</p>

<p>For the full project, please take a look at my simple <a href="https://github.com/justlaputa/karma-boilerplate">Github source</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (laputa)" rel="author">laputa</a></span></span>

      








  


<time datetime="2014-10-24T10:09:48+09:00" pubdate data-updated="true">Oct 24<span>th</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://laputa.io/blog/2014/10/24/using-karma/" data-via="justlaputa" data-counturl="http://laputa.io/blog/2014/10/24/using-karma/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/06/26/my-first-chrome-extension/" title="Previous Post: My first chrome extension">&laquo; My first chrome extension</a>
      
      
    </p>
  </footer>
</article>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - laputa -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
