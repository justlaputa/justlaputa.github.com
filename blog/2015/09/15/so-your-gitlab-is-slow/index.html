
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>So, Your Gitlab Is Slow? - Coding in the Sky</title>
  <meta name="author" content="laputa">

  
  <meta name="description" content="Our develop team use Gitlab for a long time, recently I get into some performance issues while using it. In this post, I will share our problem and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://laputa.io/blog/2015/09/15/so-your-gitlab-is-slow">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Coding in the Sky" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Coding in the Sky</a></h1>
  
    <h2>Never wait</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://github.com/justlaputa" rel="subscribe-github" title="@justlaputa on GitHub"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>
  
  
  
  
  
    
      <form action="http://google.com/search" method="get">
        <fieldset role="search">
          <input type="hidden" name="q" value="site:laputa.io" />
    
          <input class="search" type="text" name="q" results="0" placeholder="Search"/>
        </fieldset>
      </form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">So, Your Gitlab Is Slow?</h1>
      
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-15T22:00:55+09:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:00 pm</span></time>
        
        
      </p>
    
  </header>


<div class="entry-content"><p>Our develop team use Gitlab for a long time, recently I get into some performance issues while using it. In this post, I will share our problem and some tips to investigate and improve it.</p>

<h3>Problems</h3>

<p>Our develop team has about 100 individual developers, mainly working on a single big repository(about 1GB). As Gitlab CE&rsquo;s <a href="http://doc.gitlab.com/ce/install/requirements.html#cpu">official document</a> suggests:</p>

<blockquote><p>2GB RAM is the recommended memory size and supports up to 100 users</p></blockquote>

<p>In the beginning of the project, we don&rsquo;t have so much developers, and source code is not so big. We used an EC2 <em>m3.large</em> instance(2 CPU, 7.5GB MEM), it was OK. But soon, as developers and source code size increase, we find that the Gitlab website sometimes can not response quickly, and our front Nginx returns <em>502 Bad Gateway</em>. We thought is was because our EC2 instance is not powerful enough, so we upgrade to <em>m3.xlarge</em>(4CPU, 15GB MEM), it was a quick solution and worked well for some time.</p>

<p>But it does not last long, as our project is preparing to go to release cycle, and every sprint has strict deadline. Our developers tend to submit a lot of merge requests near the date of development deadline. And at that time, our Gitlab server has big problem in handling the merge request page:</p>

<ul>
<li>When developer <strong>create</strong> Merge Request, the MR page would open and Gitlab start to <strong>checking merge request</strong>, this process cost long time and sometimes it just not response with the result</li>
<li>When developer <strong>accept</strong> Merge Request, Gitlab start the merge, and show a spinner, but it takes so long time(sometimes more than 30mins), and sometimes it just never stop</li>
</ul>


<p>Even though we try to upgrade to a more powerful EC2 instance, it still can not solve the problem. I started to investigate the problem from source code.</p>

<h3>How Gitlab handles Merge Request</h3>

<p>You can find Gitlab backend architecture from the <a href="http://doc.gitlab.com/ce/development/architecture.html#system-layout">official document</a>. The key part happens in <code>gitlab-satellites</code>.</p>

<p>If login to your Gitlab server, you can find two places which stores the git repository:</p>

<p><code>/home/git/repositories</code></p>

<p>this is where the real git repository is stored, which is called as the <code>bare repository</code></p>

<p><code>/home/git/gitlab-satellites</code></p>

<p>this is a clone of the real repository from above folder. And most git operation will be happen in this <strong>satellite</strong> folder.</p>

<h4>Check merge request</h4>

<p>First, let&rsquo;s see how does Gitlab check if a merge request is mergeable.</p>

<p>When new merge request is created, it will call this function in <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/d321305c00f934db9becac1aa9726c3e9b400df5/app/controllers/projects/merge_requests_controller.rb#L140"><code>merge_request_controller.rb</code></a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">automerge_check</span>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@merge_request</span><span class="o">.</span><span class="n">unchecked?</span>
</span><span class='line'>    <span class="vi">@merge_request</span><span class="o">.</span><span class="n">check_if_can_be_merged</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">closes_issues</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">render</span> <span class="ss">partial</span><span class="p">:</span> <span class="s2">&quot;projects/merge_requests/widget/show.html.haml&quot;</span><span class="p">,</span> <span class="ss">layout</span><span class="p">:</span> <span class="kp">false</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>in <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/d321305c00f934db9becac1aa9726c3e9b400df5/app/models/merge_request.rb#L207"><code>merge_request.rb</code></a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">check_if_can_be_merged</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">Gitlab</span><span class="o">::</span><span class="no">Satellite</span><span class="o">::</span><span class="no">MergeAction</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">can_be_merged?</span>
</span><span class='line'>    <span class="n">mark_as_mergeable</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">mark_as_unmergeable</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>finally in <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/d321305c00f934db9becac1aa9726c3e9b400df5/lib/gitlab/satellite/merge_action.rb#L13"><code>merge_action.rb</code></a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">can_be_merged?</span>
</span><span class='line'>  <span class="n">in_locked_and_timed_satellite</span> <span class="k">do</span> <span class="o">|</span><span class="n">merge_repo</span><span class="o">|</span>
</span><span class='line'>    <span class="n">prepare_satellite!</span><span class="p">(</span><span class="n">merge_repo</span><span class="p">)</span>
</span><span class='line'>    <span class="n">merge_in_satellite!</span><span class="p">(</span><span class="n">merge_repo</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">merge_in_satellite!</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="n">update_satellite_source_and_target!</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">message</span> <span class="o">||=</span> <span class="s2">&quot;Merge branch &#39;</span><span class="si">#{</span><span class="n">merge_request</span><span class="o">.</span><span class="n">source_branch</span><span class="si">}</span><span class="s2">&#39; into &#39;</span><span class="si">#{</span><span class="n">merge_request</span><span class="o">.</span><span class="n">target_branch</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># merge the source branch into the satellite</span>
</span><span class='line'>  <span class="c1"># will raise CommandFailed when merge fails</span>
</span><span class='line'>  <span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">default_options</span><span class="p">({</span> <span class="ss">no_ff</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}),</span> <span class="s2">&quot;-m</span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;source/</span><span class="si">#{</span><span class="n">merge_request</span><span class="o">.</span><span class="n">source_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">Grit</span><span class="o">::</span><span class="no">Git</span><span class="o">::</span><span class="no">CommandFailed</span> <span class="o">=&gt;</span> <span class="n">ex</span>
</span><span class='line'>  <span class="n">handle_exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Assumes a satellite exists that is a fresh clone of the projects repo, prepares satellite for merges, diffs etc</span>
</span><span class='line'><span class="k">def</span> <span class="nf">update_satellite_source_and_target!</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span>
</span><span class='line'>  <span class="n">repo</span><span class="o">.</span><span class="n">remote_add</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="n">merge_request</span><span class="o">.</span><span class="n">source_project</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">path_to_repo</span><span class="p">)</span>
</span><span class='line'>  <span class="n">repo</span><span class="o">.</span><span class="n">remote_fetch</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">checkout</span><span class="p">(</span><span class="n">default_options</span><span class="p">({</span> <span class="ss">b</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}),</span> <span class="n">merge_request</span><span class="o">.</span><span class="n">target_branch</span><span class="p">,</span> <span class="s2">&quot;origin/</span><span class="si">#{</span><span class="n">merge_request</span><span class="o">.</span><span class="n">target_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">Grit</span><span class="o">::</span><span class="no">Git</span><span class="o">::</span><span class="no">CommandFailed</span> <span class="o">=&gt;</span> <span class="n">ex</span>
</span><span class='line'>  <span class="n">handle_exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see. The final call is <code>merge_in_satellite!</code> method, which will run the <code>git merge</code> command in your git repository&rsquo;s satellite folder.</p>

<h4>Accept Merge Request</h4>

<p>When user click the <strong>Accept Merge Request</strong> button, here is what happens:</p>

<p>in <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/d321305c00f934db9becac1aa9726c3e9b400df5/app/controllers/projects/merge_requests_controller.rb#L150"><code>merge_request_controller</code></a>, the <code>automerge</code> method will be called:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">automerge</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">access_denied!</span> <span class="k">unless</span> <span class="vi">@merge_request</span><span class="o">.</span><span class="n">can_be_merged_by?</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="vi">@merge_request</span><span class="o">.</span><span class="n">automergeable?</span>
</span><span class='line'>    <span class="no">AutoMergeWorker</span><span class="o">.</span><span class="n">perform_async</span><span class="p">(</span><span class="vi">@merge_request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@status</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vi">@status</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can find that it use an worker to perform an async task, this is a <a href="http://sidekiq.org/">Sidekiq</a> task:</p>

<p><a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/d321305c00f934db9becac1aa9726c3e9b400df5/app/workers/auto_merge_worker.rb#L6"><code>auto_merge_worker.rb</code></a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AutoMergeWorker</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sidekiq_options</span> <span class="ss">queue</span><span class="p">:</span> <span class="ss">:default</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">merge_request_id</span><span class="p">,</span> <span class="n">current_user_id</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">with_indifferent_access</span>
</span><span class='line'>    <span class="n">current_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">current_user_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">merge_request</span> <span class="o">=</span> <span class="no">MergeRequest</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">merge_request_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">merge_request</span><span class="o">.</span><span class="n">should_remove_source_branch</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:should_remove_source_branch</span><span class="o">]</span>
</span><span class='line'>    <span class="n">merge_request</span><span class="o">.</span><span class="n">automerge!</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">params</span><span class="o">[</span><span class="ss">:commit_message</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>and it call the <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/d321305c00f934db9becac1aa9726c3e9b400df5/app/models/merge_request.rb#L223"><code>merge_request.rb</code></a> <strong>auto_merge!</strong> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">automerge!</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">commit_message</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">unless</span> <span class="n">automergeable?</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">MergeRequests</span><span class="o">::</span><span class="no">AutoMergeService</span><span class="o">.</span>
</span><span class='line'>    <span class="kp">new</span><span class="p">(</span><span class="n">target_project</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span><span class="o">.</span>
</span><span class='line'>    <span class="n">execute</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">commit_message</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>then it calls the <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/d321305c00f934db9becac1aa9726c3e9b400df5/app/services/merge_requests/auto_merge_service.rb#L8"><code>auto_merge_service.rb</code></a> <strong>execute</strong> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">merge_request</span><span class="p">,</span> <span class="n">commit_message</span><span class="p">)</span>
</span><span class='line'>    <span class="n">merge_request</span><span class="o">.</span><span class="n">lock_mr</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="no">Gitlab</span><span class="o">::</span><span class="no">Satellite</span><span class="o">::</span><span class="no">MergeAction</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">merge_request</span><span class="p">)</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="n">commit_message</span><span class="p">)</span>
</span><span class='line'>      <span class="n">merge_request</span><span class="o">.</span><span class="n">merge</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">create_merge_event</span><span class="p">(</span><span class="n">merge_request</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'>      <span class="n">create_note</span><span class="p">(</span><span class="n">merge_request</span><span class="p">)</span>
</span><span class='line'>      <span class="n">notification_service</span><span class="o">.</span><span class="n">merge_mr</span><span class="p">(</span><span class="n">merge_request</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
</span><span class='line'>      <span class="n">execute_hooks</span><span class="p">(</span><span class="n">merge_request</span><span class="p">,</span> <span class="s1">&#39;merge&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">true</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">merge_request</span><span class="o">.</span><span class="n">unlock_mr</span>
</span><span class='line'>      <span class="kp">false</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, it use the same <code>MergeAction</code> class, but called a different method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">merge!</span><span class="p">(</span><span class="n">merge_commit_message</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="n">in_locked_and_timed_satellite</span> <span class="k">do</span> <span class="o">|</span><span class="n">merge_repo</span><span class="o">|</span>
</span><span class='line'>    <span class="n">prepare_satellite!</span><span class="p">(</span><span class="n">merge_repo</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">merge_in_satellite!</span><span class="p">(</span><span class="n">merge_repo</span><span class="p">,</span> <span class="n">merge_commit_message</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># push merge back to bare repo</span>
</span><span class='line'>      <span class="c1"># will raise CommandFailed when push fails</span>
</span><span class='line'>      <span class="n">merge_repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">default_options</span><span class="p">,</span> <span class="ss">:origin</span><span class="p">,</span> <span class="n">merge_request</span><span class="o">.</span><span class="n">target_branch</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># remove source branch</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">merge_request</span><span class="o">.</span><span class="n">remove_source_branch?</span>
</span><span class='line'>        <span class="c1"># will raise CommandFailed when push fails</span>
</span><span class='line'>        <span class="n">merge_repo</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">default_options</span><span class="p">,</span> <span class="ss">:origin</span><span class="p">,</span> <span class="s2">&quot;:</span><span class="si">#{</span><span class="n">merge_request</span><span class="o">.</span><span class="n">source_branch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">merge_request</span><span class="o">.</span><span class="n">source_project</span><span class="o">.</span><span class="n">repository</span><span class="o">.</span><span class="n">expire_branch_names</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="c1"># merge, push and branch removal successful</span>
</span><span class='line'>      <span class="kp">true</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">Grit</span><span class="o">::</span><span class="no">Git</span><span class="o">::</span><span class="no">CommandFailed</span> <span class="o">=&gt;</span> <span class="n">ex</span>
</span><span class='line'>  <span class="n">handle_exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you see, the different of <code>Accept Merge Request</code> is that it will execute the git <code>push</code> command after it merge in the satellite folder, that is absolutely what <code>Accept</code> should do.</p>

<p>You may think that, the <strong>Accept</strong> process is asynchronous, <strong>Check</strong> is synchronous, so at least these two process can be done in parallel. But there is one more thing we should see, in both <code>can_be_merged?</code> and <code>merge!</code> methods, there is a <code>in_locked_and_timed_satellite</code> method, we can find the souce in <code>action.rb</code>, but the actual implementation is in <a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/d321305c00f934db9becac1aa9726c3e9b400df5/lib/gitlab/satellite/satellite.rb#L59"><code>satellite.rb</code></a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># * Locks the satellite</span>
</span><span class='line'><span class="c1"># * Changes the current directory to the satellite&#39;s working dir</span>
</span><span class='line'><span class="c1"># * Yields</span>
</span><span class='line'><span class="k">def</span> <span class="nf">lock</span>
</span><span class='line'>  <span class="n">project</span><span class="o">.</span><span class="n">ensure_satellite_exists</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">lock_file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="n">f</span><span class="o">.</span><span class="n">flock</span> <span class="no">File</span><span class="o">::</span><span class="no">LOCK_EX</span>
</span><span class='line'>      <span class="k">yield</span>
</span><span class='line'>    <span class="k">ensure</span>
</span><span class='line'>      <span class="n">f</span><span class="o">.</span><span class="n">flock</span> <span class="no">File</span><span class="o">::</span><span class="no">LOCK_UN</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whenever checking or accepting a merge request, it locks the satellite by <a href="http://ruby-doc.org/core-2.1.5/File.html#method-i-flock">lock</a> a file, and each satellite has a single lock file. So even the accept process is asynchronous by Sidekiq, but it has to wait for the file lock if some other check or accept process is running. This whole strategy make all <strong>check</strong> and <strong>accept</strong> process running in sequential order. So when you have many developers Create/Accept merge request at same time, all process will be running in sequential, and that&rsquo;s why you have to wait long time for your merge request.</p>

<h3>The git gc</h3>

<p>Besides all process is sequential, we found another problem that affects speed. I enable the git command log by edit this file:</p>

<p><a href="https://gitlab.com/gitlab-org/gitlab-ce/blob/d321305c00f934db9becac1aa9726c3e9b400df5/config/initializers/3_grit_ext.rb"><code>config/initializers/3_grit_ext.rb</code></a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;grit&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Grit</span><span class="o">::</span><span class="no">Git</span><span class="o">.</span><span class="n">git_binary</span> <span class="o">=</span> <span class="no">Gitlab</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">bin_path</span>
</span><span class='line'><span class="no">Grit</span><span class="o">::</span><span class="no">Git</span><span class="o">.</span><span class="n">git_timeout</span> <span class="o">=</span> <span class="no">Gitlab</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">timeout</span>
</span><span class='line'><span class="no">Grit</span><span class="o">::</span><span class="no">Git</span><span class="o">.</span><span class="n">git_max_size</span> <span class="o">=</span> <span class="no">Gitlab</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">git</span><span class="o">.</span><span class="n">max_size</span>
</span><span class='line'><span class="no">Grit</span><span class="o">::</span><span class="n">debug</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then the git command detail will be logged to log file <code>unicorn_stdout.log</code>, <code>sidekiq.log</code>. We can see what&rsquo;s going on when Gitlab check or accept merge request. After I check the log file, I found that after every git merge process, it tries to run git gc:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Auto</span> <span class="n">packing</span> <span class="n">the</span> <span class="n">repository</span> <span class="k">for</span> <span class="n">optimum</span> <span class="n">performance</span><span class="o">.</span> <span class="no">You</span> <span class="n">may</span> <span class="n">also</span>
</span><span class='line'><span class="n">run</span> <span class="s2">&quot;git gc&quot;</span> <span class="n">manually</span><span class="o">.</span> <span class="no">See</span> <span class="s2">&quot;git help gc&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
</span><span class='line'><span class="ss">warning</span><span class="p">:</span> <span class="no">There</span> <span class="n">are</span> <span class="n">too</span> <span class="n">many</span> <span class="n">unreachable</span> <span class="n">loose</span> <span class="n">objects</span><span class="p">;</span> <span class="n">run</span> <span class="s1">&#39;git prune&#39;</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">them</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>The reason is that, the satellite repository is used too often, and if you&rsquo;ve got a big repository, and around 100 developers working on it, it is very likely to make many loose objects, and in which case makes git think it should run <code>gc</code> to clean up. And <code>git gc</code> cost a lot of time, what&rsquo;s more, even it runs once, the next time git merge will still trigger the gc command. The reason is as the output says, we have too many loose objects in the git repository, one way to avoid this is run <code>git prune</code> with expire option:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git prune --expire<span class="o">=</span>now
</span></code></pre></td></tr></table></div></figure>


<p>You can write a cron task to run this command regularly to clean up your gitlab satellite, it would avoid the <code>gc</code> process and enhance the gitlab performance.</p>
</div>


  <footer>
    <p class="meta">
      
  



  <span class="byline author vcard">Authored by <span class="fn">
  
    laputa
  
  </span></span>


      




<time class='entry-date' datetime='2015-09-15T22:00:55+09:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:00 pm</span></time>
      
      

<span class="categories">
  
    <a class='category' href='/blog/categories/tips/'>tips</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://laputa.io/blog/2015/09/15/so-your-gitlab-is-slow/" data-via="justlaputa" data-counturl="http://laputa.io/blog/2015/09/15/so-your-gitlab-is-slow/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/11/26/start-to-use-sublime-text/" title="Previous Post: Start to use Sublime Text">&laquo; Start to use Sublime Text</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - laputa -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'justlaputa';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://laputa.io/blog/2015/09/15/so-your-gitlab-is-slow/';
        var disqus_url = 'http://laputa.io/blog/2015/09/15/so-your-gitlab-is-slow/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
